<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Finals — Moderator Scoreboard & Live HUD</title>
  <style>
    :root{
      --bg:#0f1113;--panel:#15181b;--panel2:#1b2024;--text:#e5e7eb;--muted:#9ca3af;
      --blue:#2563eb;--red:#ef4444;--ring:#3b82f6;--warn:#f59e0b;--danger:#ef4444;--success:#22c55e;
    }
    [data-theme="light"]{
      --bg:#f6f7f9;--panel:#ffffff;--panel2:#f1f5f9;--text:#0f172a;--muted:#475569;--ring:#2563eb;--warn:#b45309;--danger:#dc2626;--success:#16a34a;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .app{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .btn{background:#1b2126;border:1px solid #2a3036;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--ring);border-color:var(--ring);color:#fff}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.success{background:var(--success);border-color:var(--success);color:#051b0b}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #23272b;border-radius:14px;padding:14px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 360px;min-width:320px}
    .kpi{background:#0d1013;border:1px solid #262a2f;border-radius:12px;padding:10px;min-width:160px}
    .timer{font-size:28px;font-weight:800}
    .teamHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .input{background:#0f1419;border:1px solid #2b3138;border-radius:10px;color:var(--text);padding:8px}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    [id^="plist-"]{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .player{position:relative;display:flex;flex-direction:column;gap:6px;align-items:flex-start;background:#0d1013;border:2px solid #262a2f;border-radius:10px;padding:8px;transition:0.2s;box-shadow:0 1px 0 #0008;width:100%}
    .player[data-team="A"]:hover{border-color:var(--blue);box-shadow:0 0 6px var(--blue)}
    .player[data-team="B"]:hover{border-color:var(--red);box-shadow:0 0 6px var(--red)}
    .weapon-slot{width:100%;display:flex;justify-content:center;align-items:center;background:transparent;border:none;border-radius:10px;margin-bottom:4px}
    .weapon-slot img{display:block;border-radius:10px;max-width:140px;max-height:72px;width:auto;height:auto}
    .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .actions .btn{flex:1 1 calc(50% - 6px);padding:6px 10px}
    button[data-kill]{background:var(--danger);border-color:var(--danger);color:#fff}
    .badge{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #0003}
    .dead{background:#2a0f12;border-color:#4b1b1f;color:#fca5a5}
    .benched{background:#26220f;border-color:#423916;color:#fde68a}
    .number{padding:2px 6px;border-radius:6px;background:#151a20;border:1px solid #20262c;font-size:13px}
    .number[data-editable]{cursor:pointer}
    .small{font-size:12px}
    .uuid{display:none} /* UUID text removed as requested */
    /* Hover copy button (visible only on hover) */
    .copy-fab{position:absolute;top:8px;right:44px;background:#ffffff22;border:1px solid #ffffff33;border-radius:999px;padding:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:.15s;z-index:2}
    .player:hover .copy-fab{opacity:1}
    .copy-fab:hover{background:#ffffff33}
    .remove-fab{position:absolute;top:8px;right:8px;background:#ffffff12;border:1px solid #ffffff22;border-radius:999px;padding:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:.15s;color:#fff;z-index:2}
    .player:hover .remove-fab{opacity:1}
    .remove-fab:hover{background:#ffffff22}
    .dup-fab{position:absolute;top:8px;right:26px;background:#ffffff18;border:1px solid #ffffff22;border-radius:999px;padding:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:.15s;color:#fff;z-index:2}
    .player:hover .dup-fab{opacity:1}
    .dup-fab:hover{background:#ffffff28}
    .drag-over{outline:2px dashed var(--ring); outline-offset:2px}
    svg.icon{width:22px;height:22px;fill:#fff}
    .log{max-height:260px;overflow:auto;font-size:13px}
    .toast{position:fixed;right:16px;bottom:16px;background:#11181c;border:1px solid #27323a;color:#e6f1f8;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    dialog{border:none;border-radius:14px;padding:16px;background:var(--panel);color:var(--text)}
    /* Widened modals */
    #settingsModal{width:80vw;max-width:80vw}
    #buyModal{width:80vw;max-width:80vw}
    @media (max-width:700px){
      #settingsModal,#buyModal{width:95vw;max-width:95vw}
    }
    .hud{max-width:600px;margin:40px auto}
    .hud .player{align-items:center;border-width:3px}
    .hud .cash-big{font-size:36px;font-weight:800;color:#22c55e}
    .hud-centered{min-height:100vh;display:flex;align-items:center;justify-content:center}
    body.hud-gradient{background:linear-gradient(135deg, #000000 0%, var(--hud-color) 100%) !important;min-height:100vh}
    body.hud-gradient .hud.panel{background:transparent;border:none;box-shadow:none}
    .hidden{display:none !important}
    /* Weapon cards shared style */
    .weapon-card{border:1px solid #262a2f;border-radius:12px;background:#0d1013;padding:10px;display:flex;flex-direction:column;gap:8px}
    .weapon-card img{width:100%;height:96px;object-fit:contain;background:#0b0e11;border-radius:8px}
    .weapon-card .meta{display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <h1>Moderator Scoreboard — <span style="color:var(--muted)">The Finals</span></h1>
      <div class="flex">
        <button class="btn" id="themeBtn">Toggle Theme</button>
        <button class="btn" id="exportBtn">Export JSON</button>
        <button class="btn" id="importBtn">Import JSON</button>
        <button class="btn" id="slotsBtn">Save/Load</button>
        <button class="btn primary" id="settingsBtn">Settings</button>
      </div>
    </div>

    <!-- HUD container -->
    <div id="hudOnly" class="hidden">
      <div class="hud panel">
        <div class="header"><h2>Live HUD</h2><div class="small" style="color:var(--muted)">Auto-updates</div></div>
        <div id="hudPlayer" class="player"></div>
      </div>
    </div>

    <!-- Moderator-only controls -->
    <div id="modOnly">
      <div class="row">
        <div class="kpi">
          <div>Quick</div>
          <div class="flex" style="flex-wrap:wrap">
            <button class="btn" id="endRound">End Round</button>
            <button class="btn" id="cashoutA">Cashout A</button>
            <button class="btn" id="cashoutB">Cashout B</button>
            <button class="btn warn" id="resetCash">Reset Cash</button>
            <button class="btn warn" id="clearWeapons">Clear Weapons</button>
            <button class="btn danger" id="resetMatch">Reset Match</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col"><div class="panel" id="teamA"></div></div>
        <div class="col"><div class="panel" id="teamB"></div></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col">
          <div class="panel">
            <h3 style="margin:0 0 8px 0">Event Log</h3>
            <div id="eventLog" class="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Toast</div>

  <!-- Settings Modal (80% width) -->
  <dialog id="settingsModal">
    <h2>Settings</h2>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <label>Kill Reward <input id="setKill" type="number" class="input"></label>
      <label>Cashout Reward <input id="setCash" type="number" class="input"></label>
      <label>Round Reward <input id="setRound" type="number" class="input"></label>
      <label>Players per Team <input id="setPPT" type="number" min="1" max="12" class="input"></label>
      <label>Team A Color <input id="setColorA" type="color" class="input"></label>
      <label>Team B Color <input id="setColorB" type="color" class="input"></label>
    </div>
    <h3>Weapon Costs</h3>
    <div id="weaponEditor" class="grid"></div>
    <div class="flex" style="margin-top:12px;justify-content:flex-end">
      <button class="btn" id="settingsClose">Close</button>
      <button class="btn" id="settingsDefaults">Reset Defaults</button>
      <button class="btn primary" id="settingsSave">Save</button>
    </div>
  </dialog>

  <!-- Save/Load Modal (small) -->
  <dialog id="slotsModal">
    <h2>Save / Load</h2>
    <div class="grid">
      <div class="flex">
        <button class="btn" data-slot-save="1">Save 1</button>
        <button class="btn" data-slot-load="1">Load 1</button>
      </div>
      <div class="flex">
        <button class="btn" data-slot-save="2">Save 2</button>
        <button class="btn" data-slot-load="2">Load 2</button>
      </div>
      <div class="flex">
        <button class="btn" data-slot-save="3">Save 3</button>
        <button class="btn" data-slot-load="3">Load 3</button>
      </div>
    </div>
  </dialog>

  <!-- Buy Weapon Modal (80% width) -->
  <dialog id="buyModal">
    <h2>Buy Weapon</h2>
    <div class="flex" style="gap:6px;margin-bottom:8px">
      <button class="btn" data-tab="Light">Light</button>
      <button class="btn" data-tab="Medium">Medium</button>
      <button class="btn" data-tab="Heavy">Heavy</button>
      <div class="flex" style="margin-left:auto">
        <input id="buyFilter" class="input" placeholder="Filter">
      </div>
    </div>
    <div id="buyGrid" class="grid cards"></div>
    <div class="flex" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="buyClose">Close</button>
    </div>
  </dialog>

  <script>
    /* =============================
       Data & Defaults
    ==============================*/
    const DEFAULTS = {
      teams:[
        { id:'A', name:'Team A', color:'#2563eb' },
        { id:'B', name:'Team B', color:'#ef4444' }
      ],
      playersPerTeam:5,
      rewards:{ kill:100, cashout:200, round:200 },
      theme:'dark'
    };

    const WEAPONS = {
      Light: {"93R":450,"ARN-220":400,"Dagger":200,"LH1":300,"M11":350,"M26 Matter":250,"Recurve Bow":300,"SH1900":350,"SR-84":300,"Sword":200,"Throwing Knives":250,"V9S":150,"XP-54":250},
      Medium: {"AKM":300,"CB-01 Repeater":350,"Cerberus 12GA":250,"CL-40":400,"Dual Blades":250,"FAMAS":450,"FCAR":400,"Model 1887":300,"P90":400,"Pike-556":350,"R.357":200,"Riot Shield":250},
      Heavy: {".50 Akimbo":400,"BFR Titan":500,"Flamethrower":250,"KS-23":200,"Lewis Gun":300,"M134 Minigun":350,"M60":350,"MGL32":150,"SA1216":450,"ShAK-50":400,"Sledgehammer":200,"Spear":150}
    };

    let state = null;
    let timer = { running:false, startAt:0, elapsed:0 };
    const $ = sel=>document.querySelector(sel);
    const $$ = sel=>Array.from(document.querySelectorAll(sel));
    const uid = ()=>crypto.randomUUID();
    const saveLocal = ()=>localStorage.setItem('finals_state', JSON.stringify(state));
    const loadLocal = ()=>JSON.parse(localStorage.getItem('finals_state')||'null');

    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

    function defaultTeamBlock(id,color,idx){
      return {
        id, name: DEFAULTS.teams[idx].name, color,
        players: Array.from({length: DEFAULTS.playersPerTeam}).map((_,i)=>({
          id: uid(), name:`Player ${i+1}`, cash:0, weapon:"Starter", dead:false, benched:false
        }))
      };
    }

    function resetToDefaults(){
      state = {
        teams:[ defaultTeamBlock('A', DEFAULTS.teams[0].color,0), defaultTeamBlock('B', DEFAULTS.teams[1].color,1) ],
        rewards:{...DEFAULTS.rewards},
        theme: localStorage.getItem('theme')||DEFAULTS.theme,
        weapons: structuredClone(WEAPONS),
        log: []
      };
      saveLocal();
      applyTheme(state.theme);
      render();
    }

    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark'); localStorage.setItem('theme', t); }

    const IMAGE_NAME_MAP = {
      // Light
      "93R":"93R","ARN-220":"ARN220","Dagger":"Dagger","LH1":"LH1","M11":"M11","M26 Matter":"M26Matter","Recurve Bow":"RecurveBow","SH1900":"SH1900","SR-84":"SR84","Sword":"Sword","Throwing Knives":"ThrowingKnives","V9S":"V9S","XP-54":"XP54",
      // Medium
      "AKM":"AKM","CB-01 Repeater":"CB01Repeater","Cerberus 12GA":"Cerberus12GA","CL-40":"CL40","Dual Blades":"DualBlades","FAMAS":"FAMAS","FCAR":"FCAR","Model 1887":"Model1887","P90":"P90","Pike-556":"Pike556","R.357":"R357","Riot Shield":"RiotShield",
      // Heavy
      ".50 Akimbo":"50Akimbo","BFR Titan":"BFRTitan","Flamethrower":"Flamethrower","KS-23":"KS23","Lewis Gun":"LewisGun","M134 Minigun":"M134Minigun","M60":"M60","MGL32":"MGL32","SA1216":"SA1216","ShAK-50":"ShAK50","Sledgehammer":"Sledgehammer","Spear":"Spear"
    };

    function weaponImgSrc(name){
      const logical = name === 'Starter' ? 'Dagger' : name;
      const fileBase = IMAGE_NAME_MAP[logical] || logical.replace(/[^a-z0-9]/gi,'');
      // Use relative path for GitHub Pages
      return "images/" + fileBase + ".png";
    }

    /* =============================
       Rendering
    ==============================*/
    function playerCard(teamId,p){
      const team = state.teams.find(t=>t.id===teamId);
      const baseUrl = location.href.split('?')[0];
      const hudLink = `${baseUrl}?player=${p.id}`;
      const wCost = p.weapon==='Starter'?0:getCost(p.weapon);
      return `
        <div class="player" data-player="${p.id}" data-team="${teamId}" draggable="true">
          <button class="copy-fab" title="Copy HUD Link" data-copy="${hudLink}">
            <svg class="icon" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/></svg>
          </button>
          <button class="dup-fab" title="Duplicate Player" data-duplicate>⧉</button>
          <button class="remove-fab" title="Remove Player" data-remove-player>❌</button>
          <div class="weapon-slot">
            <img src="${weaponImgSrc(p.weapon)}" alt="${p.weapon}" onerror="this.src='';this.style.background='transparent'" />
          </div>
          <div class="flex" style="flex-wrap:wrap">
            <input class="input name" value="${p.name}" style="min-width:160px">
            ${p.dead?'<span class="badge dead">⚰ Dead</span>':''}
            ${p.benched?'<span class="badge benched">Benched</span>':''}
          </div>
          <div class="small" style="margin-top:4px">
            Weapon: <strong>${p.weapon}</strong> <span class="number" style="margin-left:6px">$<span data-field="wcost">${wCost}</span></span>
          </div>
          <div class="small" style="margin-top:4px">
            Cash: <span class="number" data-editable>$<span data-field="cash">${p.cash}</span></span>
          </div>
          <div class="flex actions" style="margin-top:6px">
            <button class="btn" data-cash="+100">+100</button>
            <button class="btn" data-cash="-100">-100</button>
            <button class="btn" data-kill>Kill</button>
            <button class="btn" data-death>Death</button>
            <button class="btn" data-revive>Revive</button>
            <button class="btn success" data-buy="${p.id}">🛒 Buy</button>
          </div>
        </div>`;
    }

    function getCost(weapon){
      for(const [grp,obj] of Object.entries(state.weapons)) if(weapon in obj) return obj[weapon];
      return 0;
    }

    function renderTeam(teamId, mountSel){
      const team = state.teams.find(t=>t.id===teamId);
      const mount = $(mountSel);
      mount.innerHTML = `
        <div class="teamHeader">
          <div class="flex">
            <input class="input teamName" data-team="${teamId}" value="${team.name}" style="font-weight:800">
            <input class="input" type="color" value="${team.color}" data-team-color="${teamId}">
          </div>
          <div class="flex">
            <button class="btn" data-add-player="${teamId}">+ Add Player</button>
            <button class="btn warn" data-remove-last="${teamId}">Remove Last Player</button>
          </div>
        </div>
        <div class="grid" id="plist-${teamId}"></div>
      `;
      $(`#plist-${teamId}`).innerHTML = team.players.map(p=>playerCard(teamId,p)).join('');
    }

    function renderShop(){}

    function render(){
      const rwKillEl = $('#rwKill'); if(rwKillEl) rwKillEl.textContent = `+${state.rewards.kill}`;
      const rwCashEl = $('#rwCashout'); if(rwCashEl) rwCashEl.textContent = `+${state.rewards.cashout}`;
      const rwRoundEl = $('#rwRound'); if(rwRoundEl) rwRoundEl.textContent = `+${state.rewards.round}`;
      renderTeam('A','#teamA');
      renderTeam('B','#teamB');
      renderShop();
      const logHtml = state.log.slice().reverse().map(e=>`<div class="mono">${new Date(e.t).toLocaleTimeString()} — ${e.msg}</div>`).join('');
      $('#eventLog').innerHTML = logHtml || '<div style="opacity:.6">No events yet.</div>';
    }

    /* =============================
       Event Log
    ==============================*/
    function logEvent(msg){ state.log.push({t:Date.now(), msg}); if(state.log.length>200) state.log.shift(); saveLocal(); render(); }

    /* =============================
       Buy Modal
    ==============================*/
    let buyCtx = { playerId:null, tab:'Light' };

    function openBuyModal(pid){
      buyCtx.playerId = pid;
      buyCtx.tab = 'Light';
      $('#buyFilter').value='';
      renderBuyGrid();
      $('#buyModal').showModal();
    }

    function renderBuyGrid(){
      const grid = $('#buyGrid'); grid.innerHTML='';
      const term = ($('#buyFilter')?.value||'').toLowerCase();
      const items = state.weapons[buyCtx.tab];
      Object.entries(items).forEach(([name,cost])=>{
        if(term && !name.toLowerCase().includes(term)) return;
        const card=document.createElement('div');
        card.className='weapon-card';
        card.innerHTML=`
          <img src="${weaponImgSrc(name)}" alt="${name}" onerror="this.src='';this.style.background='transparent'">
          <div class="meta"><strong>${name}</strong><span class="number">$${cost}</span></div>
          <button class="btn success" data-buy-weapon="${name}" data-cost="${cost}">Buy</button>
        `;
        grid.appendChild(card);
      });
    }

    document.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;

      /* Copy HUD link */
      if(btn.classList.contains('copy-fab')){
        const link = btn.dataset.copy;
        navigator.clipboard.writeText(link).then(()=>toast("HUD link copied!"));
        return;
      }

      if(btn.id==='themeBtn'){ state.theme = (state.theme==='dark'?'light':'dark'); applyTheme(state.theme); saveLocal(); return; }

      if(btn.id==='endRound'){ state.teams.forEach(t=>t.players.forEach(p=>p.cash+=state.rewards.round)); logEvent(`End Round (+${state.rewards.round} all)`); syncAll(); return; }
      if(btn.id==='cashoutA'){ const t=state.teams.find(x=>x.id==='A'); t.players.forEach(p=>p.cash+=state.rewards.cashout); logEvent(`Team A Cashout (+${state.rewards.cashout})`); syncAll(); return; }
      if(btn.id==='cashoutB'){ const t=state.teams.find(x=>x.id==='B'); t.players.forEach(p=>p.cash+=state.rewards.cashout); logEvent(`Team B Cashout (+${state.rewards.cashout})`); syncAll(); return; }
      if(btn.id==='resetCash'){ state.teams.forEach(t=>t.players.forEach(p=>p.cash=0)); logEvent('All cash reset'); syncAll(); return; }
      if(btn.id==='clearWeapons'){ state.teams.forEach(t=>t.players.forEach(p=>p.weapon='Starter')); logEvent('All weapons cleared'); syncAll(); return; }
      if(btn.id==='resetMatch'){ if(confirm('Reset match to defaults?')){ resetToDefaults(); logEvent('Match reset'); syncAll(); } return; }

      if(btn.id==='settingsBtn'){ $('#settingsModal').showModal(); renderWeaponEditor(); $('#setKill').value=state.rewards.kill; $('#setCash').value=state.rewards.cashout; $('#setRound').value=state.rewards.round; $('#setPPT').value=state.teams[0].players.length; $('#setColorA').value=state.teams[0].color; $('#setColorB').value=state.teams[1].color; return; }
      if(btn.id==='slotsBtn'){ $('#slotsModal').showModal(); return; }

      if(btn.id==='massAdd'){ const amt=parseInt($('#massAmt').value)||0; adjustMass(amt,$('#massScope').value); syncAll(); return; }
      if(btn.id==='massSub'){ const amt=parseInt($('#massAmt').value)||0; adjustMass(-amt,$('#massScope').value); syncAll(); return; }

      if(btn.dataset.addPlayer){ const teamId=btn.dataset.addPlayer; const t=state.teams.find(x=>x.id===teamId); t.players.push({id:uid(), name:`Player ${t.players.length+1}`, cash:0, weapon:'Starter', dead:false, benched:false}); logEvent(`New player added to ${t.name}`); syncAll(); return; }

      /* Remove last player on team */
      if(btn.dataset.removeLast){ const teamId=btn.dataset.removeLast; const t=state.teams.find(x=>x.id===teamId); if(t && t.players.length>0){ const removed=t.players.pop(); logEvent(`Removed last player from ${t.name} (${removed.name})`); saveLocal(); render(); syncAll(); } return; }

      /* Player-local actions */
      const playerEl = btn.closest('.player');
      if(playerEl){
        const pid = playerEl.dataset.player;
        const { team, player } = findPlayer(pid) || {};
        if(player){
          /* Duplicate player */
          if(btn.hasAttribute('data-duplicate')){ const idx=team.players.findIndex(p=>p.id===pid); if(idx>-1){ const copy={...player, id:uid(), name:player.name+" (copy)"}; team.players.splice(idx+1,0,copy); saveLocal(); logEvent(`Duplicated ${player.name} on ${team.name}`); render(); syncAll(); } return; }
          /* Remove player */
          if(btn.hasAttribute('data-remove-player')){ const idx=team.players.findIndex(p=>p.id===pid); if(idx>-1){ const removed=team.players.splice(idx,1)[0]; logEvent(`Removed player ${removed.name} from ${team.name}`); saveLocal(); render(); syncAll(); } return; }

          /* Cash +/- */
          if(btn.dataset.cash){ const delta=parseInt(btn.dataset.cash)||0; player.cash=Math.max(0, player.cash+delta); saveLocal(); logEvent(`${player.name} cash ${delta>0?'+':''}${delta}`); pushPlayer(player); render(); return; }
          /* Kill gives reward */
          if(btn.hasAttribute('data-kill')){ player.cash+=state.rewards.kill; saveLocal(); logEvent(`${player.name} scored a kill (+$${state.rewards.kill})`); pushPlayer(player); render(); return; }

          /* Death: save lastWeapon and mark dead */
          if(btn.hasAttribute('data-death')){ if(!player.dead){ player.lastWeapon = player.weapon; player.dead=true; saveLocal(); logEvent(`${player.name} died`); pushPlayer(player); render(); } return; }

          /* Revive: restore lastWeapon or Starter */
          if(btn.hasAttribute('data-revive')){ if(player.dead){ player.dead=false; player.weapon = player.lastWeapon || 'Starter'; saveLocal(); logEvent(`${player.name} revived (restored ${player.weapon})`); pushPlayer(player); render(); } return; }

          /* Bench toggle */
          if(btn.hasAttribute('data-bench')){ player.benched=!player.benched; saveLocal(); logEvent(`${player.name} ${player.benched?'benched':'unbenched'}`); pushPlayer(player); render(); return; }
        }
      }

      /* Open Buy modal for a player */
      if(btn.dataset.buy){ openBuyModal(btn.dataset.buy); return; }

      /* Handle Buy inside modal */
      if(btn.dataset.buyWeapon){
        const pid = buyCtx.playerId;
        const { team, player } = findPlayer(pid) || {};
        if(!player) return;
        const weapon = btn.dataset.buyWeapon;
        const cost = parseInt(btn.dataset.cost)||0;
        if(player.cash < cost){ toast("Not enough cash"); return; }
        player.cash -= cost;
        player.weapon = weapon;
        saveLocal(); logEvent(`${player.name} bought ${weapon} (-$${cost})`);
        pushPlayer(player);
        $('#buyModal').close();
        render();
        return;
      }

      if(btn.id==='buyClose'){ $('#buyModal').close(); return; }
    });

    /* Drag and drop reordering within team */
    let dragPid=null;
    document.addEventListener('dragstart', (e)=>{
      const el=e.target.closest('.player'); if(!el) return;
      dragPid = el.dataset.player;
      e.dataTransfer?.setData('text/plain', dragPid);
      e.dataTransfer?.setDragImage?.(el, 20, 20);
    });
    document.addEventListener('dragover', (e)=>{
      const el=e.target.closest('.player'); if(!el) return;
      e.preventDefault(); el.classList.add('drag-over');
    });
    document.addEventListener('dragleave', (e)=>{
      const el=e.target.closest('.player'); if(!el) return;
      el.classList.remove('drag-over');
    });
    document.addEventListener('drop', (e)=>{
      const target=e.target.closest('.player'); if(!target || !dragPid) return;
      e.preventDefault(); target.classList.remove('drag-over');
      const targetPid=target.dataset.player;
      if(!targetPid || targetPid===dragPid) { dragPid=null; return; }
      const team = state.teams.find(t=>t.players.some(p=>p.id===targetPid));
      if(!team) { dragPid=null; return; }
      const fromIdx = team.players.findIndex(p=>p.id===dragPid);
      const toIdx = team.players.findIndex(p=>p.id===targetPid);
      if(fromIdx<0 || toIdx<0) { dragPid=null; return; }
      const [moved]=team.players.splice(fromIdx,1);
      team.players.splice(toIdx,0,moved);
      dragPid=null; saveLocal(); render(); logEvent(`Reordered ${moved.name} in ${team.name}`); syncAll();
    });

    document.addEventListener('change', e=>{
      const el=e.target;
      if(el.id==='weaponFilter'){ return; }
      if(el.id==='buyFilter'){ renderBuyGrid(); return; }

      if(el.matches('[data-team-color]')){
        const t=state.teams.find(x=>x.id===el.dataset.teamColor); t.color=el.value; saveLocal(); render(); return;
      }
      if(el.classList.contains('teamName')){
        const id=el.dataset.team; const t=state.teams.find(x=>x.id===id); t.name=el.value; saveLocal(); render(); return;
      }

      const playerEl = el.closest('.player'); if(!playerEl) return;
      const pid = playerEl.dataset.player;
      const team = state.teams.find(t=>t.players.some(p=>p.id===pid));
      const player = team.players.find(p=>p.id===pid);

      if(el.dataset.weapon!==undefined){ player.weapon=el.value; saveLocal(); logEvent(`${player.name} switched to ${player.weapon}`); pushPlayer(player); }
      if(el.classList.contains('name')){ player.name=el.value; saveLocal(); logEvent(`Player renamed to ${player.name}`); pushPlayer(player); }
    });

    /* Click-to-edit cash */
    document.addEventListener('click', (e)=>{
      const span = e.target.closest('.number[data-editable]'); if(!span) return;
      const playerEl = span.closest('.player'); if(!playerEl) return;
      const pid = playerEl.dataset.player; const {player} = findPlayer(pid) || {};
      if(!player) return;
      const val = prompt('Set cash amount:', String(player.cash));
      if(val!==null){ const num=Math.max(0, parseInt(val)||0); player.cash=num; saveLocal(); logEvent(`${player.name} cash set to $${num}`); pushPlayer(player); render(); }
    });

    /* Tab switching for Buy modal */
    document.addEventListener('click', (e)=>{
      const tabBtn = e.target.closest('button[data-tab]'); if(!tabBtn) return;
      buyCtx.tab = tabBtn.dataset.tab;
      renderBuyGrid();
    });

    function adjustMass(amt,scope){
      if(scope==='all'){ state.teams.forEach(t=>t.players.forEach(p=>p.cash=Math.max(0,p.cash+amt))); }
      else { const t=state.teams.find(x=>x.id===scope); t.players.forEach(p=>p.cash=Math.max(0,p.cash+amt)); }
      logEvent(`Mass adjust ${amt} to ${scope}`);
    }

    /* =============================
       Settings / Slots / Import Export
    ==============================*/
    function renderWeaponEditor(){
      const mount = $('#weaponEditor'); mount.innerHTML='';
      Object.entries(state.weapons).forEach(([group,items])=>{
        const g=document.createElement('div'); g.innerHTML=`<h4>${group}</h4>`;
        Object.entries(items).forEach(([name,cost])=>{
          const row=document.createElement('div'); row.className='flex';
          row.innerHTML=`<span style="flex:1">${name}</span><input type="number" class="input" value="${cost}" data-wedit="${group}:${name}" style="width:100px">`;
          g.appendChild(row);
        });
        mount.appendChild(g);
      });
    }

    document.addEventListener('change', e=>{
      if(e.target.dataset.wedit){
        const [grp,name]=e.target.dataset.wedit.split(':');
        state.weapons[grp][name]=parseInt(e.target.value)||0;
        saveLocal();
      }
    });

    $('#settingsSave').addEventListener('click', ()=>{
      state.rewards.kill=parseInt($('#setKill').value)||state.rewards.kill;
      state.rewards.cashout=parseInt($('#setCash').value)||state.rewards.cashout;
      state.rewards.round=parseInt($('#setRound').value)||state.rewards.round;
      const ppt=parseInt($('#setPPT').value)||state.teams[0].players.length;
      state.teams.forEach(t=>{
        while(t.players.length<ppt) t.players.push({id:uid(), name:`Player ${t.players.length+1}`, cash:0, weapon:'Starter', dead:false, benched:false});
        while(t.players.length>ppt) t.players.pop();
      });
      state.teams[0].color=$('#setColorA').value;
      state.teams[1].color=$('#setColorB').value;
      saveLocal(); render(); toast('Settings saved'); $('#settingsModal').close();
      syncAll();
    });

    $('#settingsDefaults').addEventListener('click', ()=>{ resetToDefaults(); $('#settingsModal').close(); toast('Defaults restored'); syncAll(); });
    $('#settingsClose').addEventListener('click', ()=>{ $('#settingsModal').close(); });

    $$('[data-theme-set]').forEach(b=>b.addEventListener('click',()=>{ state.theme=b.dataset.themeSet; applyTheme(state.theme); saveLocal(); }));

    $('#exportBtn').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='scoreboard.json'; a.click(); URL.revokeObjectURL(url);
    });

    $('#importBtn').addEventListener('click', ()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state=JSON.parse(r.result); saveLocal(); render(); toast('Imported'); syncAll(); }catch(e){ alert('Invalid JSON'); } }; r.readAsText(f); };
      inp.click();
    });

    $('#settingsBtn').addEventListener('click', ()=>$('#settingsModal').showModal());
    $('#slotsBtn').addEventListener('click', ()=>$('#slotsModal').showModal());
    $('#buyClose').addEventListener('click', ()=>$('#buyModal').close());

    $$('[data-slot-save]').forEach(b=>b.addEventListener('click', ()=>{ localStorage.setItem('slot'+b.dataset.slotSave, JSON.stringify(state)); toast('Saved slot '+b.dataset.slotSave); }));
    $$('[data-slot-load]').forEach(b=>b.addEventListener('click', ()=>{ const d=localStorage.getItem('slot'+b.dataset.slotLoad); if(d){ state=JSON.parse(d); saveLocal(); render(); toast('Loaded slot '+b.dataset.slotLoad); $('#slotsModal').close(); syncAll(); } }));

    /* Timer section removed */

    /* =============================
       HUD Rendering
    ==============================*/
    function renderHUD(pid){
      const mount = $('#hudPlayer');
      const found = findPlayer(pid) || {};
      const { team, player } = found;
      if(!player){ mount.innerHTML='<div class="small" style="color:var(--muted)">Player not found</div>'; return; }
      const borderColor = team?.color || '#3b82f6';
      mount.innerHTML = `
        <div class="player" data-player="${player.id}" style="border-color:${borderColor}; box-shadow:0 0 10px ${borderColor}55">
          <div class="weapon-slot">
            <img src="${weaponImgSrc(player.weapon)}" alt="${player.weapon}" onerror="this.src='';this.style.background='transparent'" />
          </div>
          <div class="flex" style="justify-content:center;width:100%"><span style="font-weight:700">${player.name}</span></div>
          <div class="cash-big">$${player.cash}</div>
          <div class="small">Weapon: ${player.weapon}</div>
          ${player.dead?'<div class="badge dead" style="margin-top:6px">⚰ Dead</div>':''}
          ${player.benched?'<div class="badge benched" style="margin-top:6px">Benched</div>':''}
        </div>`;
    }

    function isHUD(){ return new URLSearchParams(location.search).has('player'); }

    function findPlayer(pid){
      for(const t of state.teams){ for(const p of t.players){ if(p.id===pid) return {team:t,player:p}; } } return null;
    }

    function hudInit(){
      $('#modOnly').classList.add('hidden');
      $('#hudOnly').classList.remove('hidden');
      document.body.classList.add('hud-centered','hud-gradient');
    }

    /* =============================
       Firebase Sync (cash, weapon, name, dead, benched)
    ==============================*/
    const firebaseConfig = {
      apiKey: "AIzaSyASA4ZVlC_HxKDOH5nm3n5doFguxvlYSIQ",
      authDomain: "the-finals-scoreboard.firebaseapp.com",
      projectId: "the-finals-scoreboard",
      storageBucket: "the-finals-scoreboard.firebasestorage.app",
      messagingSenderId: "733685501021",
      appId: "1:733685501021:web:df9d1d63b5106a099811b4",
      measurementId: "G-C02JSSKWN5"
    };
    let fb = { enabled:false };

    (function initFirebase(){
      try{
        if(firebaseConfig && firebaseConfig.apiKey){
          const s = document.createElement('script'); s.type='module';
          s.textContent = `
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
            import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
            const app = initializeApp(${JSON.stringify(firebaseConfig)});
            const db = getFirestore(app);
            window.__fb = { db, doc, setDoc, onSnapshot, getDoc };
            document.dispatchEvent(new Event('fb-ready'));
          `;
          document.head.appendChild(s);
        }
      }catch(err){ /* ignore */ }
    })();

    document.addEventListener('fb-ready', ()=>{
      fb.enabled=true;
      if(isHUD()){
        const pid=new URLSearchParams(location.search).get('player');
        startFirestoreListener(pid);
      }
    });

    async function pushPlayer(p){
      if(!fb.enabled) return;
      try{
        const {db, doc, setDoc} = window.__fb;
        const data = { name:p.name, cash:p.cash, weapon:p.weapon, dead:p.dead, benched:p.benched };
        await setDoc(doc(db,'players', p.id), data, {merge:true});
      }catch(e){ /* ignore */ }
    }

    async function syncAll(){
      if(!fb.enabled) return;
      try {
        const ps=[];
        state.teams.forEach(t=>t.players.forEach(p=>ps.push(pushPlayer(p))));
        await Promise.all(ps);
      }catch(e){ /* ignore */ }
    }

    function startFirestoreListener(pid){
      if(!fb.enabled) return;
      try{
        const {db, doc, onSnapshot, getDoc} = window.__fb;
        getDoc(doc(db,'players', pid)).then((snap)=>{ if(snap.exists()){ const data = snap.data(); applyPlayerData(pid, data); renderHUD(pid); } });
        onSnapshot(doc(db,'players', pid), (snap)=>{ const data=snap.data(); if(data){ applyPlayerData(pid, data); renderHUD(pid); } });
      }catch(e){ /* ignore */ }
    }

    function applyPlayerData(pid, data){
      const {player} = findPlayer(pid) || {};
      if(player){
        player.name = data.name;
        player.cash = data.cash;
        player.weapon = data.weapon;
        player.dead = data.dead;
        player.benched = data.benched;
        saveLocal();
      }
    }

    /* =============================
       Boot
    ==============================*/
    function boot(){
      const saved=loadLocal();
      if(saved){ state=saved; state.weapons=saved.weapons||structuredClone(WEAPONS); state.rewards=saved.rewards||{...DEFAULTS.rewards}; state.theme=saved.theme||DEFAULTS.theme; }
      else { resetToDefaults(); }
      applyTheme(state.theme);
      if(isHUD()){ hudInit(); const pid=new URLSearchParams(location.search).get('player');
        // set dynamic hud gradient based on team color (black -> team color)
        const found=findPlayer(pid); if(found && found.team){
          const color=found.team.color; document.documentElement.style.setProperty('--hud-color', color);
        } else { document.documentElement.style.setProperty('--hud-color', '#2563eb'); }
        renderHUD(pid);
      }
      else { render(); }
    }

    boot();
  </script>
</body>
</html>
